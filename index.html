<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãŠçµµæãã‚¢ãƒ—ãƒª Ver.6</title>
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #f0f0f0;
            margin: 0;
            padding: 10px;
            touch-action: none;
        }

        h1 { margin: 10px 0; font-size: 1.2rem; color: #333; }

        .controls-container {
            background: white;
            padding: 15px;
            border-radius: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            max-width: 95%;
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 15px;
        }

        .row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            justify-content: center;
        }

        /* --- ã‚­ãƒ£ãƒ³ãƒã‚¹ã¨ã‚«ãƒ¼ã‚½ãƒ«ã®è¨­å®š --- */
        canvas {
            background-color: white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            border-radius: 4px;
            max-width: 100%;
            height: auto;
            display: block;
            
            /* â–¼ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼šãƒšãƒ³ã®ã‚«ãƒ¼ã‚½ãƒ«ï¼ˆãƒšãƒ³å…ˆãŒåŸºæº–ï¼‰ */
            cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 24 24"><path fill="black" d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>') 0 24, crosshair;
        }

        /* â–¼ æ¶ˆã—ã‚´ãƒ ãƒ¢ãƒ¼ãƒ‰ï¼šä¸¸ã„ã‚«ãƒ¼ã‚½ãƒ«ï¼ˆä¸­å¿ƒãŒåŸºæº–ï¼‰ */
        canvas.eraser-mode {
            cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="32" width="32" viewBox="0 0 32 32"><circle cx="16" cy="16" r="14" stroke="black" stroke-width="2" fill="white" opacity="0.8"/></svg>') 16 16, crosshair;
        }

        /* --- ãƒœã‚¿ãƒ³ã‚„UIã®ã‚¹ã‚¿ã‚¤ãƒ« --- */
        button {
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
            background-color: #eee;
            color: #333;
        }
        button:hover { background-color: #ddd; }
        button:active { transform: scale(0.95); }

        button.active {
            background-color: #4dabf7;
            color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .palette { display: flex; gap: 8px; }
        .color-swatch {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: transform 0.1s;
        }
        .color-swatch:hover { transform: scale(1.1); }
        .color-swatch.selected { border: 2px solid #333; transform: scale(1.1); }

        #clearBtn { background-color: #ff8787; color: white; }
        #saveBtn { background-color: #69db7c; color: white; }
        #undoBtn { background-color: #ffc078; color: white; }

        input[type="range"] { width: 100px; cursor: pointer; }
        #fileInput { display: none; }
    </style>
</head>
<body>

    <h1>ãŠçµµæãã‚¢ãƒ—ãƒª Ver.6</h1>

    <div class="controls-container">
        <!-- ãƒ„ãƒ¼ãƒ«é¡ -->
        <div class="row">
            <button id="undoBtn" title="ã²ã¨ã¤æˆ»ã‚‹">â†©ï¸ æˆ»ã‚‹</button>
            <button id="penBtn" class="active">âœï¸ ãƒšãƒ³</button>
            <button id="eraserBtn">ğŸ§¹ æ¶ˆã—ã‚´ãƒ </button>
            <button id="clearBtn">ğŸ—‘ï¸ å…¨æ¶ˆå»</button>
        </div>

        <!-- ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆ -->
        <div class="row palette" id="palette"></div>

        <!-- è¨­å®šãƒ»ãƒ•ã‚¡ã‚¤ãƒ« -->
        <div class="row">
            <label>å¤ªã•: <input type="range" id="lineWidth" min="1" max="50" value="5"></label>
            <label>ã‚«ã‚¹ã‚¿ãƒ è‰²: <input type="color" id="colorPicker" value="#000000"></label>
            
            <button id="loadBtn" onclick="document.getElementById('fileInput').click()">ğŸ–¼ï¸ ç”»åƒèª­è¾¼</button>
            <input type="file" id="fileInput" accept="image/*">
            <button id="saveBtn">ğŸ’¾ ä¿å­˜</button>
        </div>
    </div>

    <canvas id="myCanvas" width="800" height="600"></canvas>

    <script>
        const canvas = document.getElementById('myCanvas');
        const ctx = canvas.getContext('2d');
        const colorPicker = document.getElementById('colorPicker');
        const lineWidthRange = document.getElementById('lineWidth');
        
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;
        let currentMode = 'pen';
        let penWidth = 5;
        let eraserWidth = 30;
        let savedColor = '#000000';
        
        // Undoå±¥æ­´
        let drawHistory = [];
        const MAX_HISTORY = 10;

        ctx.lineJoin = 'round';
        ctx.lineCap = 'round';
        ctx.lineWidth = penWidth;

        // ãƒ‘ãƒ¬ãƒƒãƒˆç”Ÿæˆ
        const colors = ['#000000', '#FF0000', '#0000FF', '#008000', '#FFFF00', '#FFA500', '#FFC0CB', '#800080', '#A52A2A', '#808080'];
        const paletteContainer = document.getElementById('palette');
        colors.forEach(color => {
            const swatch = document.createElement('div');
            swatch.className = 'color-swatch';
            swatch.style.backgroundColor = color;
            swatch.onclick = () => changeColor(color);
            paletteContainer.appendChild(swatch);
        });

        function changeColor(color) {
            savedColor = color;
            colorPicker.value = color;
            switchTool('pen');
            updatePaletteUI(color);
        }

        function updatePaletteUI(activeColor) {
            const swatches = document.querySelectorAll('.color-swatch');
            swatches.forEach(s => {
                if (rgbToHex(s.style.backgroundColor) === activeColor.toLowerCase()) {
                    s.classList.add('selected');
                } else {
                    s.classList.remove('selected');
                }
            });
        }
        
        function rgbToHex(rgb) {
            if (rgb.startsWith('#')) return rgb.toLowerCase();
            const rgbValues = rgb.match(/\d+/g);
            return "#" + ((1 << 24) + (parseInt(rgbValues[0]) << 16) + (parseInt(rgbValues[1]) << 8) + parseInt(rgbValues[2])).toString(16).slice(1).toLowerCase();
        }

        function saveState() {
            if (drawHistory.length >= MAX_HISTORY) drawHistory.shift();
            drawHistory.push(ctx.getImageData(0, 0, canvas.width, canvas.height));
        }

        document.getElementById('undoBtn').addEventListener('click', () => {
            if (drawHistory.length > 0) {
                const lastState = drawHistory.pop();
                ctx.putImageData(lastState, 0, 0);
            }
        });

        document.getElementById('saveBtn').addEventListener('click', () => {
            const link = document.createElement('a');
            link.download = 'my-drawing.png';
            link.href = canvas.toDataURL();
            link.click();
        });

        document.getElementById('fileInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    if(confirm("ç”»åƒã‚’èª­ã¿è¾¼ã¿ã¾ã™ã‹ï¼Ÿï¼ˆä»Šã®çµµã¯æ¶ˆãˆã¾ã™ï¼‰")){
                        canvas.width = img.width;
                        canvas.height = img.height;
                        ctx.drawImage(img, 0, 0);
                        ctx.lineJoin = 'round';
                        ctx.lineCap = 'round';
                        if (currentMode === 'pen') {
                            ctx.strokeStyle = savedColor;
                            ctx.lineWidth = penWidth;
                        } else {
                            ctx.strokeStyle = '#ffffff';
                            ctx.lineWidth = eraserWidth;
                        }
                        drawHistory = [];
                    }
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
            e.target.value = '';
        });

        // ãƒ„ãƒ¼ãƒ«åˆ‡ã‚Šæ›¿ãˆï¼ˆã‚«ãƒ¼ã‚½ãƒ«å¤‰æ›´å‡¦ç†ã‚‚å«ã‚€ï¼‰
        function switchTool(mode) {
            currentMode = mode;
            const penBtn = document.getElementById('penBtn');
            const eraserBtn = document.getElementById('eraserBtn');

            if (mode === 'pen') {
                ctx.strokeStyle = savedColor;
                ctx.lineWidth = penWidth;
                lineWidthRange.value = penWidth;
                
                // ã‚«ãƒ¼ã‚½ãƒ«ã‚’ãƒšãƒ³ã«æˆ»ã™
                canvas.classList.remove('eraser-mode');
                
                penBtn.classList.add('active');
                eraserBtn.classList.remove('active');
            } else if (mode === 'eraser') {
                savedColor = colorPicker.value;
                ctx.strokeStyle = '#ffffff';
                ctx.lineWidth = eraserWidth;
                lineWidthRange.value = eraserWidth;
                
                // ã‚«ãƒ¼ã‚½ãƒ«ã‚’æ¶ˆã—ã‚´ãƒ ï¼ˆä¸¸ï¼‰ã«ã™ã‚‹
                canvas.classList.add('eraser-mode');
                
                penBtn.classList.remove('active');
                eraserBtn.classList.add('active');
            }
        }

        document.getElementById('penBtn').addEventListener('click', () => switchTool('pen'));
        document.getElementById('eraserBtn').addEventListener('click', () => switchTool('eraser'));
        
        lineWidthRange.addEventListener('input', (e) => {
            const width = e.target.value;
            ctx.lineWidth = width;
            if (currentMode === 'pen') penWidth = width;
            else eraserWidth = width;
        });

        colorPicker.addEventListener('input', (e) => {
            changeColor(e.target.value);
        });

        document.getElementById('clearBtn').addEventListener('click', () => {
            if(confirm('æœ¬å½“ã«å…¨éƒ¨æ¶ˆã—ã¾ã™ã‹ï¼Ÿ')) {
                saveState();
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
        });

        function startDrawing(e) {
            isDrawing = true;
            saveState();
            [lastX, lastY] = getCoordinates(e);
        }

        function draw(e) {
            if (!isDrawing) return;
            e.preventDefault();
            const [currentX, currentY] = getCoordinates(e);
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(currentX, currentY);
            ctx.stroke();
            [lastX, lastY] = [currentX, currentY];
        }

        function stopDrawing() { isDrawing = false; }

        function getCoordinates(e) {
            const rect = canvas.getBoundingClientRect();
            let clientX, clientY;
            if (e.type.includes('touch')) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            return [(clientX - rect.left) * scaleX, (clientY - rect.top) * scaleY];
        }

        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing);
        canvas.addEventListener('touchstart', startDrawing);
        canvas.addEventListener('touchmove', draw);
        canvas.addEventListener('touchend', stopDrawing);

        updatePaletteUI(savedColor);
    </script>
</body>
</html>